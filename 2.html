<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Anime Archive</title>
    <style>
        :root {
            --primary: #6366f1;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card: #ffffff;
            --placeholder: #e2e8f0;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            margin: 0;
            padding: 20px;
            color: #334155;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        .search-section {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input,
        textarea,
        select {
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
        }

        input[type="text"] {
            flex-grow: 1;
        }

        button {
            cursor: pointer;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            transition: 0.3s;
            font-weight: bold;
        }

        .btn-main {
            background: var(--primary);
            color: white;
        }

        .btn-main:hover {
            background: #4f46e5;
        }

        .btn-manual {
            background: #64748b;
            color: white;
        }

        #search-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .search-item {
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #e2e8f0;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }

        .search-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
        }

        #manual-form {
            display: none;
            margin-top: 15px;
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .anime-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .anime-card {
            display: flex;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .anime-card img,
        .no-image-placeholder {
            width: 120px;
            height: 170px;
            flex-shrink: 0;
            object-fit: cover;
        }

        .no-image-placeholder {
            background: var(--placeholder);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #94a3b8;
        }

        .anime-info {
            padding: 15px;
            flex-grow: 1;
            position: relative;
        }

        .anime-info h3 {
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .anime-date {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 10px;
        }

        .memo-edit {
            width: 100%;
            border: 1px solid transparent;
            background: #f1f5f9;
            resize: none;
            font-size: 13px;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 4px;
            color: #475569;
            height: 60px;
        }

        .memo-edit:focus {
            background: #fff;
            border-color: var(--primary);
            outline: none;
        }

        .delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #fee2e2;
            color: var(--danger);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: var(--danger);
            color: white;
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>My Anime Archive</h1>
            <p>è¦‹ãŸã‚¢ãƒ‹ãƒ¡ã‚’è¨˜éŒ²ã—ã‚ˆã†</p>
        </header>

        <section class="search-section">
            <div class="input-group">
                <input type="text" id="search-input" placeholder="ã‚¢ãƒ‹ãƒ¡ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›..."
                    onkeypress="if(event.key === 'Enter') searchAnime()">
                <button class="btn-main" onclick="searchAnime()">APIã§æ¤œç´¢</button>
                <button class="btn-manual" onclick="toggleManualForm()">æ‰‹å‹•ã§è¿½åŠ </button>
            </div>

            <div id="search-results"></div>

            <div id="manual-form">
                <h4>æ‰‹å‹•ã§è©³ç´°ã‚’å…¥åŠ›</h4>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <input type="text" id="m-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«">
                    <input type="text" id="m-date" placeholder="æ—¥ä»˜ (ä¾‹: 2025-10-13)">
                    <input type="text" id="m-img" placeholder="ç”»åƒURL (ä»»æ„)">
                    <textarea id="m-memo" placeholder="ä¸€æ–‡ãƒ¡ãƒ¢"></textarea>
                    <button class="btn-main" onclick="addAnimeManual()">ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                </div>
            </div>
        </section>

        <div class="controls">
            <label>ä¸¦ã¹æ›¿ãˆ:
                <select id="sort-select" onchange="renderList()">
                    <option value="newest">ç™»éŒ²ãŒæ–°ã—ã„é †</option>
                    <option value="oldest">ç™»éŒ²ãŒå¤ã„é †</option>
                    <option value="title">ã‚¿ã‚¤ãƒˆãƒ«é †</option>
                    <option value="date_asc">æ”¾é€æ™‚æœŸï¼šå¤ã„é †</option>
                    <option value="date_desc">æ”¾é€æ™‚æœŸï¼šæ–°ã—ã„é †</option>
                </select>
            </label>
            <div id="count">åˆè¨ˆ: 0ä½œå“</div>
        </div>

        <div id="anime-list" class="anime-list"></div>
    </div>

    <script>
        let animeData = JSON.parse(localStorage.getItem('myAnimeList')) || [];

        function formatDate(dateStr) {
            if (!dateStr || dateStr === "Unknown" || dateStr === "ä¸æ˜") return "ä¸æ˜";
            const cleanStr = dateStr.split(' to ')[0];
            const date = new Date(cleanStr);
            if (isNaN(date.getTime())) return dateStr;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥`;
        }

        async function searchAnime() {
            const query = document.getElementById('search-input').value;
            if (!query) return;
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = "æ¤œç´¢ä¸­...";
            try {
                const response = await fetch(`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                resultsDiv.innerHTML = "";
                data.data.forEach(anime => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.innerHTML = `
                    <img src="${anime.images.jpg.image_url}">
                    <div>${anime.title_japanese || anime.title}</div>
                `;
                    div.onclick = () => prepareAdd(anime);
                    resultsDiv.appendChild(div);
                });
            } catch (error) {
                resultsDiv.innerHTML = "æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ";
            }
        }

        function prepareAdd(anime) {
            const newItem = {
                id: Date.now(),
                title: anime.title_japanese || anime.title,
                date: formatDate(anime.aired.string),
                image: anime.images.jpg.image_url,
                memo: "",
                timestamp: Date.now()
            };
            saveAnime(newItem);
        }

        function addAnimeManual() {
            const title = document.getElementById('m-title').value;
            const rawDate = document.getElementById('m-date').value;
            const img = document.getElementById('m-img').value;
            const memo = document.getElementById('m-memo').value;

            if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™");

            const newItem = {
                id: Date.now(),
                title: title,
                date: formatDate(rawDate),
                image: img || null,
                memo: memo,
                timestamp: Date.now()
            };
            saveAnime(newItem);
            toggleManualForm();
            document.querySelectorAll('#manual-form input, #manual-form textarea').forEach(el => el.value = "");
        }

        function saveAnime(item) {
            animeData.push(item);
            localStorage.setItem('myAnimeList', JSON.stringify(animeData));
            document.getElementById('search-results').innerHTML = "";
            document.getElementById('search-input').value = "";
            renderList();
        }

        function updateMemo(id, newText) {
            const index = animeData.findIndex(item => item.id === id);
            if (index !== -1) {
                animeData[index].memo = newText;
                localStorage.setItem('myAnimeList', JSON.stringify(animeData));
            }
        }

        function deleteAnime(id) {
            if (confirm("æœ¬å½“ã«ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                animeData = animeData.filter(item => item.id !== id);
                localStorage.setItem('myAnimeList', JSON.stringify(animeData));
                renderList();
            }
        }

        // --- æ—¥ä»˜æ¯”è¼ƒç”¨ã®æ•°å€¤ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•° ---
        function getNumericDate(dateStr) {
            if (!dateStr || dateStr === "ä¸æ˜") return null;
            const digits = dateStr.match(/\d+/g);
            return digits ? digits.join('') : null; // "2025å¹´10æœˆ13æ—¥" -> "20251013"
        }

        function renderList() {
            const listDiv = document.getElementById('anime-list');
            const sortVal = document.getElementById('sort-select').value;
            const countDisplay = document.getElementById('count');

            let sorted = [...animeData];

            // ä¸¦ã¹æ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯
            sorted.sort((a, b) => {
                if (sortVal === 'newest') return b.timestamp - a.timestamp;
                if (sortVal === 'oldest') return a.timestamp - b.timestamp;
                if (sortVal === 'title') return a.title.localeCompare(b.title, 'ja');
                if (sortVal === 'date_asc' || sortVal === 'date_desc') {
                    const dateA = getNumericDate(a.date);
                    const dateB = getNumericDate(b.date);
                    // ä¸¡æ–¹ä¸æ˜ãªã‚‰ãã®ã¾ã¾
                    if (dateA === null && dateB === null) return 0;
                    // aãŒä¸æ˜ãªã‚‰å¸¸ã«å¾Œã‚ï¼ˆä¸‹ï¼‰ã¸
                    if (dateA === null) return 1;
                    // bãŒä¸æ˜ãªã‚‰å¸¸ã«å¾Œã‚ï¼ˆä¸‹ï¼‰ã¸
                    if (dateB === null) return -1;
                    // ä¸¡æ–¹æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã®æ¯”è¼ƒ
                    if (sortVal === 'date_asc') return dateA.localeCompare(dateB);
                    if (sortVal === 'date_desc') return dateB.localeCompare(dateA);
                }
            });

            listDiv.innerHTML = "";
            countDisplay.innerText = `åˆè¨ˆ: ${sorted.length}ä½œå“`;

            sorted.forEach(item => {
                const card = document.createElement('div');
                card.className = 'anime-card';
                const imageHtml = (item.image && item.image !== "")
                    ? `<img src="${item.image}" alt="${item.title}">`
                    : `<div class="no-image-placeholder">ğŸ‘</div>`;

                card.innerHTML = `

                ${imageHtml}
                <div class="anime-info">
                    <h3>${item.title}</h3>
                    <div class="anime-date">æ”¾é€ãƒ»è¨˜éŒ²æ™‚æœŸ: ${item.date}</div>
                    <textarea 
                        class="memo-edit" 
                        placeholder="ãƒ¡ãƒ¢ã‚’è¨˜å…¥..." 
                        onchange="updateMemo(${item.id}, this.value)">${item.memo}</textarea>
                    <button class="delete-btn" onclick="deleteAnime(${item.id})">å‰Šé™¤</button>
                </div>
            `;
                listDiv.appendChild(card);
            });
        }

        function toggleManualForm() {
            const form = document.getElementById('manual-form');
            const searchInput = document.getElementById('search-input');
            const manualTitle = document.getElementById('m-title');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
                manualTitle.value = searchInput.value;
            } else {
                form.style.display = 'none';
            }
        }

        renderList();
    </script>

</body>

</html>